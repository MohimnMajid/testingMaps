<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      direction: rtl;
      text-align: center;
    }
    #map {
      height: 400px;
      width: 100%;
      margin-top: 10px;
    }
    .popup {
      display: none;
      position: fixed;
      top: 5%;
      left: 10%;
      width: 80%;
      background: white;
      border: 1px solid #ccc;
      padding: 15px;
      box-shadow: 0 0 10px #333;
      z-index: 1000;
    }
    .popup.show { display: block; }
    #coords, #whatsappLink { display: none; margin-top: 10px; }
    button {
      padding: 8px 12px;
      margin: 5px;
      border: none;
      border-radius: 6px;
      background: #007bff;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    #whatsappLink {
      display: inline-block;
      padding: 8px 12px;
      background: #25D366;
      color: white;
      border-radius: 6px;
      text-decoration: none;
    }
  </style>
</head>
<body>

<h2>ğŸ“ Ù…Ø´Ø§Ø±ÙƒØ© Ù…ÙˆÙ‚Ø¹ÙŠ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</h2>
<button onclick="openMap()">ÙØªØ­ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>

<div class="popup" id="popup">
  <p>Ø§Ø³Ø­Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø£Ùˆ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¨Ø¯Ù‚Ø©</p>
  <div id="map"></div>
  <button onclick="confirmLocation()">âœ”ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
  <p id="coords"></p>
  <a id="whatsappLink" target="_blank">ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a><br><br>
  <button onclick="closeMap()">Ø¥ØºÙ„Ø§Ù‚</button>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script>
  let map, marker;
  const phoneNumber = "9647817420071"; // Ø§Ù„Ø±Ù‚Ù… Ø¨ØµÙŠØºØ© Ø¯ÙˆÙ„ÙŠØ©
  let currentLat, currentLng;

  function openMap() {
    document.getElementById("popup").classList.add("show");

    if (!map) { // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…Ø±Ø© ÙˆØ­Ø¯Ø© ÙÙ‚Ø·
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          initMap(lat, lng);
        }, () => {
          initMap(33.3152, 44.3661); // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø¨ØºØ¯Ø§Ø¯
        });
      } else {
        alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
        initMap(33.3152, 44.3661);
      }
    }
  }

  function initMap(lat, lng) {
    map = L.map('map').setView([lat, lng], 15);

    // Ø·Ø¨Ù‚Ø© Ø®Ø±ÙŠØ·Ø© Ù…Ù† OpenStreetMap (ØªØ¸Ù‡Ø± Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    marker = L.marker([lat, lng], {draggable:true}).addTo(map);

    currentLat = lat;
    currentLng = lng;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø¹Ù†Ø¯ Ø³Ø­Ø¨ Ø§Ù„Ù…Ø§Ø±ÙƒØ±
    marker.on("dragend", function() {
      const pos = marker.getLatLng();
      currentLat = pos.lat;
      currentLng = pos.lng;
    });

    // ØªØ­Ø¯ÙŠØ« Ø¹Ù†Ø¯ ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    map.on("moveend", function() {
      const center = map.getCenter();
      marker.setLatLng(center);
      currentLat = center.lat;
      currentLng = center.lng;
    });

    // âœ… Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ù…Ø§ÙƒÙ†
    L.Control.geocoder({
      defaultMarkGeocode: false
    })
    .on('markgeocode', function(e) {
      const bbox = e.geocode.bbox;
      const poly = L.polygon([
        bbox.getSouthEast(),
        bbox.getNorthEast(),
        bbox.getNorthWest(),
        bbox.getSouthWest()
      ]);
      map.fitBounds(poly.getBounds());
      marker.setLatLng(e.geocode.center);
      currentLat = e.geocode.center.lat;
      currentLng = e.geocode.center.lng;
    })
    .addTo(map);
  }

  function confirmLocation() {
    const coordsText = `https://www.google.com/maps?q=${currentLat},${currentLng}`;
    document.getElementById("coords").textContent = coordsText;
    document.getElementById("coords").style.display = "block";

    // ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø±
    const encodedMessage = encodeURIComponent(`Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${coordsText}`);
    document.getElementById("whatsappLink").href =
      `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
    document.getElementById("whatsappLink").style.display = "inline-block";
  }

  function closeMap() {
    document.getElementById("popup").classList.remove("show");
  }
</script>

</body>
</html>
